# Лабораторные работы
## Постановка задачи (Вариант 18)
### Классный руководитель
Сущности: Имеются ученики (фамилия, имя, домашний адрес, телефон, ФИО отца
и матери) и предметы (название).

Процессы: Накапливаются сведения об
успеваемости учеников по предметам с указанием оценок, дат и сведений
о пропусках.

Выходные документы:
+ Выдать список учеников, получивших двойки или пропустивших
занятия в определенный интервал дат.
+ Выдать список учеников и предметов, по которым число пятерок
больше заданного, отсортированный ученикам и предметам.

# Лабораторная работа №1

## ER-диаграмма

![alt_text](er_diag1.png)

## Логическая модель

### Ученик

ID_ученика (INT PRIMARY KEY) - уникальный идентификатор ученика

Имя (VARCHAR) - имя ученика

Фамилия (VARCHAR) - фамилия ученика

Домашний_адрес - адрес проживания

Телефон VARCHAR - контактный телефон

ФИО_матери (VARCHAR) - полное имя матери

ФИО_отца (VARCHAR) - полное имя отца

### Предмет

ID_предмета (INT PRIMARY KEY) - уникаьлный идентификатор предмета

Навзание_предмета (VARCHAR) - название учебного предмета

### Успеваемость

ID_записи (INT PRIMARY KEY) - уникальный идентификатор записи

ID_ученика (INT FOREIGN KEY) - ссылка на ученика

ID_предмета (INT FOREIGN KEY) - ссылка на предмет

Оценка (INT) - полученнная оценка (от 1 до 5)

Дата (DATE) - дата получения оценки

Пропуски (BOOLEAN) - отметка о пропуске

## Физическая модель

    -- Таблица учеников
    CREATE TABLE Ученик (
        ID_ученика INT PRIMARY KEY,
        Фамилия VARCHAR(50) NOT NULL,
        Имя VARCHAR(50) NOT NULL,
        Домашний_адрес VARCHAR(200),
        Телефон VARCHAR(20),
        ФИО_матери VARCHAR(100),
        ФИО_отца VARCHAR(100)
    );

    -- Таблица предметов
    CREATE TABLE Предмет (
        ID_предмета INT PRIMARY KEY,
        Название_предмета VARCHAR(100) NOT NULL UNIQUE
    );

    -- Таблица успеваемости
    CREATE TABLE Успеваемость (
        ID_записи INT PRIMARY KEY,
        ID_ученика INT NOT NULL,
        ID_предмета INT NOT NULL,
        Оценка INT CHECK (Оценка BETWEEN 1 AND 5),
        Дата DATE NOT NULL,
        Пропуски BOOLEAN DEFAULT FALSE,
    
        -- Внешние ключи
        FOREIGN KEY (ID_ученика) REFERENCES Ученик(ID_ученика) 
            ON DELETE RESTRICT ON UPDATE CASCADE,
        FOREIGN KEY (ID_предмета) REFERENCES Предмет(ID_предмета) 
            ON DELETE RESTRICT ON UPDATE CASCADE
    );

## Ответ DeepSeek

### Положительные аспекты:
Полное соответствие постановке задачи - все сущности и атрибуты из условия учтены

Корректная ER-диаграмма - правильно отображены связи между сущностями (1:N)

Нормализованная структура - модель соответствует 3NF, исключено дублирование данных

Правильные типы данных - адекватный выбор VARCHAR, INT, DATE, BOOLEAN

Оптимизация запросов - созданы необходимые индексы для требуемых отчетов

### Рекомендации по улучшению:

+ Добавить ограничение CHECK для оценок (хотя в физической модели оно уже есть)

+ Рассмотреть возможность хранения количества пропусков вместо BOOLEAN, если нужна статистика

+ Добавить индекс по комбинации (Дата, Оценка) для ускорения первого отчета

### SQL-запросы для выходных документов

#### Список учеников с двойками или пропусками за период:
    
    SELECT 
        У.Фамилия,
        У.Имя,
        П.Название_предмета,
        Ус.Оценка,
        Ус.Дата,
        CASE WHEN Ус.Пропуски THEN 'Да' ELSE 'Нет' END AS Пропуск
    FROM Успеваемость Ус
    JOIN Ученик У ON Ус.ID_ученика = У.ID_ученика
    JOIN Предмет П ON Ус.ID_предмета = П.ID_предмета
    WHERE (Ус.Оценка = 2 OR Ус.Пропуски = TRUE)
      AND Ус.Дата BETWEEN '2024-01-01' AND '2024-12-31'
    ORDER BY У.Фамилия, У.Имя, Ус.Дата;

#### Список учеников с количеством пятерок больше заданного:

    SELECT 
        У.Фамилия,
        У.Имя,
        П.Название_предмета,
        COUNT(*) AS Количество_пятерок
    FROM Успеваемость Ус
    JOIN Ученик У ON Ус.ID_ученика = У.ID_ученика
    JOIN Предмет П ON Ус.ID_предмета = П.ID_предмета
    WHERE Ус.Оценка = 5
    GROUP BY У.ID_ученика, П.ID_предмета
    HAVING COUNT(*) > 0  -- заданное число пятерок
    ORDER BY У.Фамилия, У.Имя, П.Название_предмета;

### Оценка выполнения


Модель демонстрирует глубокое понимание принципов проектирования баз данных и готова к промышленной эксплуатации. Все поставленные задачи решены оптимальным образом.

# Лабораторная работа №2

## Таблицы

![ученик](https://github.com/user-attachments/assets/7c9bf333-b476-4571-bc90-117d81f706f9)

![предмет](https://github.com/user-attachments/assets/bb25c673-5b8a-4e7d-a7e3-7160b6166dd1)

![успеваемость](https://github.com/user-attachments/assets/cc54712f-c66a-42b2-bbfe-5d6aa6b626bd)

## Заполнение таблиц данными

![заполнение1](https://github.com/user-attachments/assets/79db3190-659e-426a-8eb2-4f25c6594bbd)

![заполнение2](https://github.com/user-attachments/assets/e9d8654d-8c3b-407d-8367-593cbea91b94)

![заполнение3](https://github.com/user-attachments/assets/875a77c2-592d-45c5-9e6d-1d32cc0817e5)

## SELECT-запросы с JOIN

### Запрос 1. Список учеников с двойками или пропусками за период

![запрос1](https://github.com/user-attachments/assets/e0a665f8-7615-45c1-a23a-7620c2aaa8c5)

### Запрос 2. Список учеников с количеством пятерок больше заданного

![запрос2](https://github.com/user-attachments/assets/b08ea963-472a-4728-b8b7-1a880effe0d9)

### Запрос 3. Средний балл учеников

![запрос3](https://github.com/user-attachments/assets/575c991d-9088-42e1-8620-64e39f681437)

# Лабораторная работа №3

## Создание представлений

### Представление 1. Полная информация об успеваемости

![представление1](https://github.com/user-attachments/assets/030b7cc2-0f4e-40f7-bc12-5a09d9a0de3d)

### Представление 2. Рейтинг предметов

![представление2](https://github.com/user-attachments/assets/de6f11f7-7bfc-4210-92fa-ab24915b110b)

## Создание хранимых процедур

### Процедура 1. Подробная статистика предмета

![процедура1](https://github.com/user-attachments/assets/e28b5f95-f97a-4ecd-8a74-c8fe5e60e47d)

#### Проверка

![проверка1](https://github.com/user-attachments/assets/8f11cff4-68c5-4175-8c05-1b764b46aa05)

### С изменениями данных

### Процедура 2. Добавление нового ученика

![процедура2](https://github.com/user-attachments/assets/0ba259bc-3f3e-43bf-95fd-dd561d184ec4)

#### Проверка

![проверка2](https://github.com/user-attachments/assets/87eec182-f51a-4d73-9792-8b7718ca81ed)

### Процедура 3. Добавление нового предмета

![процедура3](https://github.com/user-attachments/assets/2867b2b4-84f4-47cc-ae0a-aa6ee06120d9)

#### Проверка

![проверка3](https://github.com/user-attachments/assets/af0dcc8f-7e4a-4ae7-a113-032c3824d931)

# Лабораторная работа №4

## Генераторы

### Генератор учеников

![генератор1](https://github.com/user-attachments/assets/277bcf32-aa17-4158-b5ef-d320cef1f72e)

### Генератор предметов

![генератор2](https://github.com/user-attachments/assets/3af12d0d-2762-4cb2-bc72-4ea48aa2f6b6)

### Генератор успеваемости

![генератор3](https://github.com/user-attachments/assets/68c62d3d-ea55-4c05-8f91-4882cb17ca2e)

#### Генерация 20000 записей

![20000](https://github.com/user-attachments/assets/89f20a77-af41-451f-85a1-cb5de41a9767)

## Оптимизация

При выполнении запроса происходит последовательное сканирование всей таблицы (Seq Scan), что занимает 14.440 мс даже для относительно небольшой базы данных. Без специализированных индексов такие запросы всегда будут требовать полного сканирования таблицы, что неприемлемо для систем с растущим объемом данных и требованиями к отзывчивости

### Анализ производительности запроса до оптимизации

![до](https://github.com/user-attachments/assets/baa6b5f5-bb55-4071-9206-b4188e05e445)

Анализ результатов до оптимизации:

Время выполнения 14.440 мс.
Тип сканирования Seq Scan.
Seq Scan - полное последовательное сканирование таблицы "Предмет", в ходе которого PostgreSQL читает все 40,000 строк таблицы подряд, от первой до последней, каждая строка проверяется на соответствие условию LIKE '%Математика%', операция выполняется медленно (14.218 мс) и требует чтения всех 298 буферов данных. В результате возвращаются 2,666 подходящих строк, но только после того, как были прочитаны и отброшены 37,334 неподходящих строк

Текущая реализация запроса демонстрирует классический случай неоптимального поиска по шаблонам в PostgreSQL. Поэтому, оптимизируем запросы при помощи GIN-индекса, который позволяет эффективно выполнять поиск по шаблонам с начальными и конечными символами подстановки (LIKE '%текст%')

### Анализ производительности запроса после оптимизации

![после](https://github.com/user-attachments/assets/b3f736a9-435d-48aa-a4d9-372cff6da41c)

Анализ результатов после оптимизации:

Время выполнения 5.957 мс.
Тип сканирования Bitmap Index Scan. Bitmap Index Scan - сканирование GIN-индекса idx_предмет_поиск, в ходе которого по триграммам слова "Математика" ищутся все строки, содержащие нужные последовательности символов, создается bitmap - структура, где каждый бит соответствует странице таблицы и указывает, есть ли на ней потенциально подходящие строки, операция выполняется очень быстро (за 0.001 мс) и использует всего 25 буферов в памяти

После оптимизации мы видим, что производительность запроса значительно улучшилась

# Лабораторная работа №5

## Триггер каскадного удаления успеваемости при удалении ученика

![триггер1](https://github.com/user-attachments/assets/d7a374ed-4b58-4024-aa6d-fb9ca85e4822)

![триггер2](https://github.com/user-attachments/assets/08c07662-4ebf-4dc5-8eba-f93e5b39907b)

## Создание таблицы аудита

![таблица](https://github.com/user-attachments/assets/7865bf27-b974-487a-bc5f-042d3657dbd6)

## Создание функции и триггера аудита

![триггер3](https://github.com/user-attachments/assets/67263407-86a3-4265-a73c-68926cc48201)

![триггер4](https://github.com/user-attachments/assets/18c097d0-cf58-4def-a280-3afea6a3da3a)

## Журнал аудита

![проверка](https://github.com/user-attachments/assets/ebc83f82-0692-438c-af54-8bb81d78057c)












